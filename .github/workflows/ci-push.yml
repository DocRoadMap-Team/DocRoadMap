name: Notify on Push

on:
  push:
    branches:
      - "*"

jobs:
  notify-discord:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Github push check
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          COMMIT_MESSAGE=$(git log -1 --pretty=format:"%s")
          AUTHOR_NAME=$GITHUB_ACTOR
          BRANCH_NAME=${GITHUB_REF#refs/heads/}
          REPO_NAME=${GITHUB_REPOSITORY}
          COMMIT_URL="https://github.com/$REPO_NAME/commit/$(git rev-parse HEAD)"

          EMBED_COLOR=16776960

          JSON_PAYLOAD=$(jq -n \
            --arg title "üì¢ Nouveau push sur $REPO_NAME" \
            --arg author "üë§ Auteur: $AUTHOR_NAME" \
            --arg branch "üåø Branche: $BRANCH_NAME" \
            --arg commit "üìù Commit: $COMMIT_MESSAGE" \
            --arg url "$COMMIT_URL" \
            --argjson color "$EMBED_COLOR" \
            '{
              "embeds": [
                {
                  "title": $title,
                  "color": $color,
                  "fields": [
                    { "name": "üë§ Auteur", "value": $author, "inline": true },
                    { "name": "üåø Branche", "value": $branch, "inline": true },
                    { "name": "üìù Commit", "value": $commit },
                    { "name": "üîó Voir le commit", "value": "[Lien vers le commit](\($url))" }
                  ],
                  "footer": { "text": "üöÄ Push automatique - GitHub Actions" }
                }
              ]
            }')

          curl -H "Content-Type: application/json" \
               -X POST \
               -d "$JSON_PAYLOAD" \
               "$DISCORD_WEBHOOK_URL"
